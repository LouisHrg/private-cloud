version: "3.7"

services:

  traefik:
    build:
      context: ./
      dockerfile: ./build/Dockerfile-traefik
    image: traefik:custom
    container_name: traefik
    restart: unless-stopped
    volumes:
      - certificates:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - cryptpad_network
      - maps_network
      - directus_network
    ports:
      - "443:443"

  maps:
    # See https://hub.docker.com/r/akhenakh/kvtiles/tags for available tags / zooms
    image: akhenakh/kvtiles:planet-10-latest
    container_name: maps
    restart: unless-stopped
    command: ["-tilesKey=maps.narah.io"] # entrypoint is ["./kvtilesd"]
    networks:
      - maps_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.maps.entrypoints=websecure"
      - "traefik.http.routers.maps.rule=Host(`maps.narah.io`)"
      - "traefik.http.routers.maps.tls=true"
      - "traefik.http.routers.maps.tls.certresolver=default"
      - "traefik.http.routers.maps.middlewares=security@file"
      - "traefik.http.services.maps.loadbalancer.server.port=8080"

  database:
    image: postgis/postgis:13-master
    volumes:
      - directus-data:/var/lib/postgresql/data
    networks:
      - directus_network
    environment:
      POSTGRES_USER: '${POSTGRES_USER}'
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: '${POSTGRES_DB}'

  cache:
    image: redis:6
    networks:
      - directus_network

  directus:
    image: directus/directus:latest
    ports:
      - 8055:8055
    volumes:
      - directus-uploads:/directus/uploads
      - ./directus/modules:/directus/extensions/modules
    networks:
      - directus_network
    depends_on:
      - cache
      - database
    environment:
      KEY: '${DIRECTUS_KEY}'
      SECRET: '${DIRECTUS_SECRET}'

      DB_CLIENT: 'pg'
      DB_HOST: 'database'
      DB_PORT: '5432'
      DB_DATABASE: '${POSTGRES_DB}'
      DB_USER: '${POSTGRES_USER}'
      DB_PASSWORD: '${POSTGRES_PASSWORD}'

      CACHE_ENABLED: 'false'
      CACHE_STORE: 'redis'
      CACHE_REDIS: 'redis://cache:6379'

      ADMIN_EMAIL: '${DIRECTUS_ADMIN_EMAIL}'
      ADMIN_PASSWORD: '${DIRECTUS_ADMIN_PWD}'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.rule=Host(`api.narah.io`)"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.tls.certresolver=default"
      - "traefik.http.routers.api.middlewares=security@file"
      - "traefik.http.services.api.loadbalancer.server.port=8055"

  cryptpad:
    build:
      context: ./
      dockerfile: ./build/Dockerfile-cryptpad
      args:
        version: "5.2.1"
    image: cryptpad:custom
    container_name: cryptpad
    restart: unless-stopped
    volumes:
      - files_cryptpad_volume:/cryptpad/data
    networks:
      - cryptpad_network
    labels:
      - "traefik.enable=true"
      # See https://github.com/xwiki-labs/cryptpad/blob/main/docs/example.nginx.conf
      # First case (secure)
      - "traefik.http.routers.cryptpad-safe.entrypoints=websecure"
      - "traefik.http.routers.cryptpad-safe.rule=(Host(`pad.narah.io`) && !PathPrefix(`/unsafeiframe/inner.html`)) || (Host(`sb.narah.io`) && !Path(`/{t:(sheet|doc|presentation)}/inner.html{n:.*}`, `/common/onlyoffice/{n:.*}/{m:.*}.html{r:.*}`))"
      - "traefik.http.routers.cryptpad-safe.tls=true"
      - "traefik.http.routers.cryptpad-safe.tls.certresolver=default"
      - "traefik.http.services.cryptpad-safe.loadbalancer.server.port=3000"
      - "traefik.http.routers.cryptpad-safe.service=cryptpad-safe"
      - "traefik.http.middlewares.custom.headers.accessControlAllowOriginList=sb.narah.io"
      - "traefik.http.middlewares.custom.headers.contentSecurityPolicy=default-src 'none'; child-src https://pad.narah.io; worker-src 'self'; media-src blob:; style-src 'unsafe-inline' 'self' https://pad.narah.io; script-src 'self' resource: https://pad.narah.io; connect-src 'self' https://pad.narah.io blob: wss://pad.narah.io https://sb.narah.io; font-src 'self' data: https://pad.narah.io; img-src 'self' data: blob: https://pad.narah.io; frame-src 'self' https://sb.narah.io blob:; frame-ancestors 'self' https://pad.narah.io"
      - "traefik.http.middlewares.cryptpad-safe-chain.chain.middlewares=custom,cryptpad@file,security@file"
      - "traefik.http.routers.cryptpad-safe.middlewares=cryptpad-safe-chain"
      # Second case (unsafe)
      - "traefik.http.routers.cryptpad-unsafe.entrypoints=websecure"
      - "traefik.http.routers.cryptpad-unsafe.rule=(Host(`pad.narah.io`) && PathPrefix(`/unsafeiframe/inner.html`)) || (Host(`sb.narah.io`) && Path(`/{t:(sheet|doc|presentation)}/inner.html{n:.*}`, `/common/onlyoffice/{n:.*}/{m:.*}.html{r:.*}`))"
      - "traefik.http.routers.cryptpad-unsafe.tls=true"
      - "traefik.http.routers.cryptpad-unsafe.tls.certresolver=default"
      - "traefik.http.services.cryptpad-unsafe.loadbalancer.server.port=3000"
      - "traefik.http.routers.cryptpad-unsafe.service=cryptpad-unsafe"
      - "traefik.http.middlewares.custom2.headers.accessControlAllowOriginList=sb.narah.io"
      - "traefik.http.middlewares.custom2.headers.contentSecurityPolicy=default-src 'none'; child-src https://pad.narah.io; worker-src 'self'; media-src blob:; style-src 'unsafe-inline' 'self' https://pad.narah.io; script-src 'self' 'unsafe-eval' 'unsafe-inline' resource: https://pad.narah.io; connect-src 'self' https://pad.narah.io blob: wss://pad.narah.io https://sb.narah.io; font-src 'self' data: https://pad.narah.io; img-src 'self' data: blob: https://pad.narah.io; frame-src 'self' https://sb.narah.io blob:; frame-ancestors 'self' https://pad.narah.io"
      - "traefik.http.middlewares.cryptpad-unsafe-chain.chain.middlewares=custom2,cryptpad@file,security@file"
      - "traefik.http.routers.cryptpad-unsafe.middlewares=cryptpad-unsafe-chain"


networks:
  cryptpad_network: ~
  maps_network: ~
  directus_network: ~

volumes:
  certificates:
    name: certificates
  files_cryptpad_volume:
  directus-data:
  directus-uploads:

FROM php:7.3-fpm

LABEL maintainer="tchap@tchap.me"

# Run update, and gets basic packages
RUN apt-get update && apt-get install -y --no-install-recommends \
        curl \
        unzip \
        # There are for php-intl
        zlib1g-dev libicu-dev g++ \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Configure PHP extensions
RUN docker-php-ext-configure pdo_mysql --with-pdo-mysql=mysqlnd \
    && docker-php-ext-install pdo_mysql \
    && docker-php-ext-install intl \
    && docker-php-source delete

# Davis installation
RUN cd /var/www/ && curl --silent -o 1.4.3.tar.gz -L https://github.com/tchapi/davis/archive/v1.4.3.tar.gz \
 && tar xvzf 1.4.3.tar.gz \
 && mv -f /var/www/davis-1.4.3 /var/www/davis \
 && rm 1.4.3.tar.gz

WORKDIR /var/www/davis

RUN rm -rf docker _screenshots README.md

# Install dependencies
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
RUN APP_ENV=prod composer install --no-ansi --no-dev --no-interaction --no-progress --optimize-autoloader

RUN chown -R www-data:www-data var
